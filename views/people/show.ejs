<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Person Details</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
  <nav class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex">
          <div class="flex-shrink-0 flex items-center">
            <a href="/dashboard">
              <img class="h-8 w-8" src="/images/logo.svg" alt="Logo">
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>
  <div class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="bg-white rounded-lg shadow-md p-8">
      <div class="flex items-center mb-8">
        <% if (person.photoUrl) { %>
          <img src="<%= person.photoUrl %>" alt="Person Photo" class="w-24 h-24 rounded-full mr-8">
        <% } %>
        <div>
          <h2 class="text-2xl font-bold text-gray-800"><%= person.name %></h2>
          <p class="text-gray-600"><%= person.dob.toDateString() %></p>
        </div>
      </div>

      <h3 class="text-xl font-bold text-gray-800 mb-4">Bookings</h3>
      <% if (user.role.name === 'Police') { %>
        <a href="/people/<%= person.id %>/bookings/new" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mb-4 inline-block">New Booking</a>
        <a href="/print/wrapsheet/<%= person.id %>" class="btn-primary ml-4">Print Wrapsheet</a>
      <% } %>
      <ul>
        <% person.bookings.forEach(booking => { %>
          <li class="border-b border-gray-200 py-4">
            <p><strong>Booking Date:</strong> <%= booking.bookingDate.toLocaleString() %></p>
            <p><strong>Status:</strong> <%= booking.status %></p>
            <% if (booking.custodyExpiresAt) { %>
              <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Custody Expires In:</strong>
                <span class="block sm:inline" id="countdown-<%= booking.id %>"></span>
              </div>
              <script>
                const countdown_<%= booking.id %> = () => {
                  const countDownDate = new Date("<%= booking.custodyExpiresAt %>").getTime();
                  const now = new Date().getTime();
                  const distance = countDownDate - now;

                  const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                  const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                  const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                  document.getElementById("countdown-<%= booking.id %>").innerHTML = `${hours}h ${minutes}m ${seconds}s`;

                  if (distance < 0) {
                    clearInterval(x_<%= booking.id %>);
                    document.getElementById("countdown-<%= booking.id %>").innerHTML = "EXPIRED";
                  }
                };
                const x_<%= booking.id %> = setInterval(countdown_<%= booking.id %>, 1000);
              </script>
            <% } %>
            <% if (booking.case) { %>
              <p><strong>Case Number:</strong> <a href="/cases/<%= booking.case.id %>" class="text-blue-500 hover:underline"><%= booking.case.caseNumber %></a></p>
            <% } else if (user.role.name === 'Police') { %>
              <a href="/cases/new/<%= booking.id %>" class="text-blue-500 hover:underline">Create Case</a>
            <% } %>
          </li>
        <% }) %>
      </ul>

      <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4">Custody Timeline</h3>
      <div class="relative">
        <div class="border-l-2 border-blue-500 absolute h-full left-4"></div>
        <% person.bookings.forEach(booking => { %>
          <div class="mb-8 flex items-center w-full">
            <div class="bg-blue-500 rounded-full h-8 w-8 flex items-center justify-center text-white mr-4 z-10">B</div>
            <div class="bg-gray-200 rounded-lg p-4 flex-1">
              <p class="font-bold">Booking #<%= booking.id %></p>
              <p><%= new Date(booking.bookingDate).toLocaleString() %></p>
            </div>
          </div>
          <% booking.remandRequests.forEach(request => { %>
            <div class="mb-8 flex items-center w-full">
              <div class="bg-yellow-500 rounded-full h-8 w-8 flex items-center justify-center text-white mr-4 z-10">R</div>
              <div class="bg-gray-200 rounded-lg p-4 flex-1">
                <p class="font-bold">Remand Request</p>
                <p>Status: <%= request.status %></p>
                <p>Requested Days: <%= request.requestedDays %></p>
              </div>
            </div>
          <% }) %>
          <% if (booking.releaseRecord) { %>
            <div class="mb-8 flex items-center w-full">
              <div class="bg-green-500 rounded-full h-8 w-8 flex items-center justify-center text-white mr-4 z-10">R</div>
              <div class="bg-gray-200 rounded-lg p-4 flex-1">
                <p class="font-bold">Release</p>
                <p><%= new Date(booking.releaseRecord.releaseDate).toLocaleString() %></p>
                <p>Reason: <%= booking.releaseRecord.reason %></p>
              </div>
            </div>
          <% } %>
        <% }) %>
      </div>

      <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4">Next of Kin</h3>
      <a href="/next-of-kin/new/<%= person.id %>" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mb-4 inline-block">Add Next of Kin</a>
      <ul>
        <% person.nextOfKin.forEach(kin => { %>
          <li class="border-b border-gray-200 py-4">
            <p><strong>Name:</strong> <%= kin.name %></p>
            <p><strong>Relationship:</strong> <%= kin.relationship %></p>
            <p><strong>Phone:</strong> <%= kin.phone %></p>
            <p><strong>Address:</strong> <%= kin.address %></p>
          </li>
        <% }) %>
      </ul>
    </div>
  </div>
</body>
</html>
